<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨­å‚™è¨˜æ†¶ç¿»ç‰Œå­¸ç¿’éŠæˆ²</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .animate-spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* è‡ªå®šç¾©æ²è»¸ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Firebase SDKs using standard script tags for better compatibility in single-file setup -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- Firebase é…ç½® ---
        // é€™è£¡æœƒå˜—è©¦æŠ“å–é–‹ç™¼ç’°å¢ƒè®Šæ•¸ï¼Œè‹¥éƒ¨ç½²åˆ° GitHub Pagesï¼Œè«‹å°‡æ‚¨çš„ Firebase Config è²¼åœ¨ä¸‹æ–¹ else å€å¡Š
        let firebaseConfig = {};
        try {
            if (typeof __firebase_config !== 'undefined') {
                firebaseConfig = JSON.parse(__firebase_config);
            }
        } catch (e) {
            console.error("Firebase config parsing error", e);
        }

        // å¦‚æœæ‚¨åœ¨ GitHub ä¸Šçœ‹åˆ°ç©ºç™½ï¼Œè«‹å°‡ Firebase æ§åˆ¶å°çš„ config è²¼åˆ°é€™è£¡ï¼š
        if (!firebaseConfig.apiKey) {
            // firebaseConfig = { apiKey: "...", authDomain: "...", projectId: "...", ... };
        }

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'memory-learning-game';

        // --- åœ–æ¨™çµ„ä»¶ ---
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={`inline-block ${className}`}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('menu'); // menu, game, quiz, admin_login, admin, result
            const [cardsData, setCardsData] = useState([]);
            const [difficulty, setDifficulty] = useState(null);
            
            // éŠæˆ²ç‹€æ…‹
            const [gameState, setGameState] = useState({
                cards: [],
                flipped: [],
                matched: [],
                currentMatchInfo: null,
                matchedCardsData: [],
            });

            // æ¸¬é©—ç‹€æ…‹
            const [quizState, setQuizState] = useState({
                questions: [],
                currentIndex: 0,
                score: 0,
                results: []
            });

            // 1. åˆå§‹åŒ–èˆ‡è³‡æ–™åŒæ­¥
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await auth.signInWithCustomToken(__initial_auth_token);
                        } else {
                            await auth.signInAnonymously();
                        }
                    } catch (err) {
                        console.error("Auth Error", err);
                    }
                };
                initAuth();
                const unsubscribeAuth = auth.onAuthStateChanged(setUser);
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('deviceCards');
                const unsubscribe = collectionRef.onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCardsData(data);
                }, (err) => console.error("Firestore Error:", err));
                return () => unsubscribe();
            }, [user]);

            // 2. éŠæˆ²é‚è¼¯
            const startGame = (diff) => {
                setDifficulty(diff);
                let pairsCount = diff === 'easy' ? 8 : (diff === 'medium' ? 12 : 18);

                if (cardsData.length < pairsCount) {
                    alert(`è³‡æ–™åº«è³‡æ–™ä¸è¶³ï¼ç›®å‰åƒ…æœ‰ ${cardsData.length} ç¨®è¨­å‚™ï¼Œè«‹å…ˆé€²å…¥å¾Œå°æ–°å¢ï¼ˆè‡³å°‘éœ€ ${pairsCount} ç¨®ï¼‰ã€‚`);
                    return;
                }

                const selectedData = [...cardsData].sort(() => 0.5 - Math.random()).slice(0, pairsCount);
                let cards = [];
                selectedData.forEach((item, index) => {
                    const baseCard = { deviceId: item.id, name: item.name, image: item.image, info: item.info };
                    cards.push({ ...baseCard, instanceId: `${index}-a` });
                    cards.push({ ...baseCard, instanceId: `${index}-b` });
                });

                cards = cards.sort(() => 0.5 - Math.random());

                if (diff === 'medium') {
                    cards.splice(12, 0, { isSpacer: true });
                }

                setGameState({
                    cards,
                    flipped: [],
                    matched: [],
                    currentMatchInfo: null,
                    matchedCardsData: selectedData
                });
                setView('game');
            };

            const handleCardClick = (index) => {
                const { flipped, matched, cards } = gameState;
                if (flipped.length === 2 || matched.includes(index) || flipped.includes(index) || cards[index].isSpacer) return;

                const newFlipped = [...flipped, index];
                setGameState(prev => ({ ...prev, flipped: newFlipped }));

                if (newFlipped.length === 2) {
                    const card1 = cards[newFlipped[0]];
                    const card2 = cards[newFlipped[1]];

                    if (card1.deviceId === card2.deviceId) {
                        setTimeout(() => {
                            const newMatched = [...matched, newFlipped[0], newFlipped[1]];
                            setGameState(prev => ({
                                ...prev,
                                matched: newMatched,
                                flipped: [],
                                currentMatchInfo: card1
                            }));
                        }, 500);
                    } else {
                        setTimeout(() => {
                            setGameState(prev => ({ ...prev, flipped: [] }));
                        }, 1000);
                    }
                }
            };

            const startQuiz = () => {
                const questions = gameState.matchedCardsData.map(item => ({
                    deviceId: item.id,
                    deviceName: item.name,
                    question: item.question,
                    options: item.options,
                    correct: item.correct
                })).sort(() => 0.5 - Math.random());

                setQuizState({ questions, currentIndex: 0, score: 0, results: [] });
                setView('quiz');
            };

            // --- è¦–åœ–çµ„ä»¶ ---

            const MainMenu = () => (
                <div className="flex flex-col items-center justify-center min-h-screen p-6">
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                        <div className="mb-6 inline-flex p-4 bg-indigo-100 rounded-2xl text-indigo-600">
                            <Icon name="book-open" size={48} />
                        </div>
                        <h1 className="text-3xl font-bold text-slate-800 mb-2">è¨­å‚™è¨˜æ†¶ç¿»ç‰Œ</h1>
                        <p className="text-slate-500 mb-8">é…å°è¨­å‚™ä¸¦å­¸ç¿’å°ˆæ¥­çŸ¥è­˜</p>
                        
                        <div className="space-y-4 text-left">
                            <button onClick={() => startGame('easy')} className="w-full flex items-center justify-between p-4 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-xl transition-all">
                                <div>
                                    <span className="block font-bold text-emerald-700 text-lg">ç°¡å–® (4x4)</span>
                                    <span className="text-xs text-emerald-600">é©åˆåˆå­¸è€…</span>
                                </div>
                                <Icon name="play" className="text-emerald-400" />
                            </button>
                            <button onClick={() => startGame('medium')} className="w-full flex items-center justify-between p-4 bg-amber-50 hover:bg-amber-100 border border-amber-200 rounded-xl transition-all">
                                <div>
                                    <span className="block font-bold text-amber-700 text-lg">ä¸­ç­‰ (5x5)</span>
                                    <span className="text-xs text-amber-600">ä¸­é–“ç‚ºå“ç‰Œç©ºæ ¼</span>
                                </div>
                                <Icon name="play" className="text-amber-400" />
                            </button>
                            <button onClick={() => startGame('hard')} className="w-full flex items-center justify-between p-4 bg-rose-50 hover:bg-rose-100 border border-rose-200 rounded-xl transition-all">
                                <div>
                                    <span className="block font-bold text-rose-700 text-lg">å›°é›£ (6x6)</span>
                                    <span className="text-xs text-rose-600">é«˜é›£åº¦è¨˜æ†¶æŒ‘æˆ°</span>
                                </div>
                                <Icon name="play" className="text-rose-400" />
                            </button>
                        </div>

                        <button onClick={() => setView('admin_login')} className="mt-10 text-slate-400 hover:text-indigo-600 flex items-center gap-2 text-sm mx-auto transition-colors">
                            <Icon name="settings" size={16} /> å¾Œå°ç®¡ç†ç™»å…¥
                        </button>
                    </div>
                </div>
            );

            const AdminLogin = () => {
                const [creds, setCreds] = useState({ user: '', pass: '' });
                const handleLogin = (e) => {
                    e.preventDefault();
                    if (creds.user === 'Admin01' && creds.pass === '76380260') {
                        setView('admin');
                    } else {
                        alert('å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤ï¼');
                    }
                };
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-slate-100">
                        <form onSubmit={handleLogin} className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full">
                            <div className="flex justify-center mb-4 text-indigo-600">
                                <Icon name="lock" size={40} />
                            </div>
                            <h2 className="text-2xl font-bold mb-6 text-center">ç®¡ç†å“¡èº«åˆ†é©—è­‰</h2>
                            <div className="space-y-4">
                                <input type="text" placeholder="ç®¡ç†å“¡å¸³è™Ÿ" className="w-full p-4 bg-slate-50 border rounded-xl outline-none focus:ring-2 ring-indigo-500" value={creds.user} onChange={e => setCreds({...creds, user: e.target.value})} />
                                <input type="password" placeholder="ç®¡ç†å“¡å¯†ç¢¼" className="w-full p-4 bg-slate-50 border rounded-xl outline-none focus:ring-2 ring-indigo-500" value={creds.pass} onChange={e => setCreds({...creds, pass: e.target.value})} />
                                <button type="submit" className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition-colors">ç™»å…¥å¾Œå°</button>
                                <button type="button" onClick={() => setView('menu')} className="w-full text-slate-400 py-2 hover:text-slate-600">è¿”å›ä¸»é¸å–®</button>
                            </div>
                        </form>
                    </div>
                );
            };

            const AdminView = () => {
                const [newItem, setNewItem] = useState({
                    name: '', image: '', info: '', question: 'è«‹å•ä¸‹åˆ—å“ªä¸€é …æ˜¯é—œæ–¼ {name} çš„æ­£ç¢ºæè¿°ï¼Ÿ', options: ['', '', '', ''], correct: 0
                });
                const [editingId, setEditingId] = useState(null);
                const [loading, setLoading] = useState(false);

                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('deviceCards');

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!newItem.name || !newItem.image || !newItem.info) return alert('è«‹å¡«å¯«å®Œæ•´è³‡è¨Š');
                    setLoading(true);
                    try {
                        if (editingId) {
                            await collectionRef.doc(editingId).update(newItem);
                            alert('è³‡æ–™å·²æˆåŠŸæ›´æ–°ï¼');
                        } else {
                            await collectionRef.add(newItem);
                            alert('æ–°è¨­å‚™å·²æˆåŠŸæ–°å¢ï¼');
                        }
                        resetForm();
                    } catch (err) { 
                        console.error(err);
                        alert('æ“ä½œå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™è¨­å®šã€‚');
                    }
                    setLoading(false);
                };

                const resetForm = () => {
                    setNewItem({ name: '', image: '', info: '', question: 'è«‹å•ä¸‹åˆ—å“ªä¸€é …æ˜¯é—œæ–¼ {name} çš„æ­£ç¢ºæè¿°ï¼Ÿ', options: ['', '', '', ''], correct: 0 });
                    setEditingId(null);
                };

                const startEdit = (item) => {
                    setNewItem({ ...item });
                    setEditingId(item.id);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const deleteItem = async (id) => {
                    if (!confirm('ç¢ºå®šè¦å¾¹åº•åˆªé™¤æ­¤è¨­å‚™è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œä¸å¯é‚„åŸã€‚')) return;
                    try {
                        await collectionRef.doc(id).delete();
                    } catch (err) { console.error(err); }
                };

                return (
                    <div className="min-h-screen bg-slate-50 p-6">
                        <div className="max-w-6xl mx-auto">
                            <div className="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border">
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-3">
                                    <Icon name="settings" className="text-indigo-600" /> å¾Œå°è³‡æ–™ç®¡ç†ä¸­å¿ƒ
                                </h1>
                                <button onClick={() => setView('menu')} className="bg-slate-200 hover:bg-slate-300 px-6 py-2 rounded-xl font-bold transition-colors">è¿”å›å‰ç«¯éŠæˆ²</button>
                            </div>

                            <div className="grid lg:grid-cols-2 gap-8">
                                <div className="bg-white p-8 rounded-3xl shadow-sm border border-indigo-100">
                                    <h2 className="text-xl font-bold mb-6 flex items-center gap-2 text-indigo-600">
                                        <Icon name={editingId ? "edit-3" : "plus-circle"} size={24} /> 
                                        {editingId ? "ç·¨è¼¯ç¾æœ‰è¨­å‚™å…§å®¹" : "æ–°å¢å­¸ç¿’è¨­å‚™"}
                                    </h2>
                                    <form onSubmit={handleSubmit} className="space-y-5">
                                        <div>
                                            <label className="block text-sm font-bold text-slate-500 mb-1">è¨­å‚™åç¨±</label>
                                            <input value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border-2 border-transparent outline-none focus:border-indigo-500 transition-all" placeholder="ä¾‹å¦‚ï¼šç£æŒ¯é€ å½±å„€ (MRI)" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-slate-500 mb-1">åœ–ç‰‡é€£çµ (URL)</label>
                                            <input value={newItem.image} onChange={e => setNewItem({...newItem, image: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border-2 border-transparent outline-none focus:border-indigo-500 transition-all" placeholder="è«‹è²¼ä¸Šåœ–ç‰‡ç¶²å€" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-bold text-slate-500 mb-1">è¨­å‚™å­¸ç¿’ä»‹ç´¹ (ç¿»ç‰Œé…å°æ™‚é¡¯ç¤º)</label>
                                            <textarea value={newItem.info} onChange={e => setNewItem({...newItem, info: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border-2 border-transparent outline-none h-32 focus:border-indigo-500 transition-all" placeholder="è«‹è¼¸å…¥è©³ç´°çš„è¨­å‚™ç”¨é€”æˆ–ä»‹ç´¹æ–‡å­—..." />
                                        </div>
                                        <div className="p-4 bg-indigo-50 rounded-2xl border border-indigo-100">
                                            <h3 className="font-bold text-indigo-700 text-sm mb-3">æ¸¬é©—é¡Œç›®è¨­å®š</h3>
                                            <label className="block text-xs font-bold text-slate-400 mb-1">é¡Œç›®æ¨¡æ¿ (ä½¿ç”¨ {'{name}'} è‡ªå‹•å¸¶å…¥è¨­å‚™å)</label>
                                            <input value={newItem.question} onChange={e => setNewItem({...newItem, question: e.target.value})} className="w-full p-3 mb-4 rounded-lg border-none outline-none focus:ring-2 ring-indigo-400" />
                                            <div className="space-y-2">
                                                {newItem.options.map((opt, idx) => (
                                                    <div key={idx} className="flex gap-2 items-center">
                                                        <input type="radio" name="correct" checked={newItem.correct === idx} onChange={() => setNewItem({...newItem, correct: idx})} className="w-4 h-4" />
                                                        <input value={opt} onChange={e => {
                                                            const newOpts = [...newItem.options];
                                                            newOpts[idx] = e.target.value;
                                                            setNewItem({...newItem, options: newOpts});
                                                        }} className="flex-1 p-2 bg-white border rounded-lg text-sm outline-none" placeholder={`é¸é … ${idx + 1}`} />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex gap-3">
                                            <button disabled={loading} type="submit" className="flex-1 bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-indigo-700 disabled:opacity-50 transition-all">
                                                {loading ? "è™•ç†ä¸­..." : (editingId ? 'å„²å­˜ä¿®æ”¹' : 'ç¢ºèªæ–°å¢')}
                                            </button>
                                            {editingId && <button type="button" onClick={resetForm} className="px-6 py-4 bg-slate-200 rounded-2xl font-bold hover:bg-slate-300 transition-colors">å–æ¶ˆ</button>}
                                        </div>
                                    </form>
                                </div>

                                <div className="space-y-4">
                                    <div className="flex justify-between items-center">
                                        <h2 className="text-xl font-bold text-slate-800">å·²å»ºç«‹è¨­å‚™åº« ({cardsData.length})</h2>
                                    </div>
                                    <div className="max-h-[800px] overflow-y-auto space-y-4 pr-2">
                                        {cardsData.map(item => (
                                            <div key={item.id} className="bg-white p-5 rounded-2xl flex items-center gap-5 border shadow-sm group hover:border-indigo-300 transition-all">
                                                <img src={item.image} className="w-24 h-24 rounded-xl object-cover bg-slate-100 flex-shrink-0" onError={(e) => e.target.src='https://via.placeholder.com/100?text=No+Img'} />
                                                <div className="flex-1 min-w-0">
                                                    <h4 className="font-bold text-slate-800 text-lg truncate">{item.name}</h4>
                                                    <p className="text-sm text-slate-400 line-clamp-2 mt-1">{item.info}</p>
                                                    <div className="flex gap-4 mt-3">
                                                        <button onClick={() => startEdit(item)} className="text-sm text-indigo-600 font-bold hover:bg-indigo-50 px-3 py-1 rounded-lg transition-colors flex items-center gap-1">
                                                            <Icon name="edit" size={14} /> ç·¨è¼¯
                                                        </button>
                                                        <button onClick={() => deleteItem(item.id)} className="text-sm text-rose-500 font-bold hover:bg-rose-50 px-3 py-1 rounded-lg transition-colors flex items-center gap-1">
                                                            <Icon name="trash-2" size={14} /> åˆªé™¤
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                        {cardsData.length === 0 && (
                                            <div className="text-center py-20 text-slate-300">
                                                <Icon name="inbox" size={48} className="mx-auto mb-2" />
                                                <p>ç›®å‰è³‡æ–™åº«æ˜¯ç©ºçš„ï¼Œè«‹ç”±å·¦å´æ–°å¢</p>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const GameBoard = () => {
                const gridCols = difficulty === 'easy' ? 'grid-cols-4' : (difficulty === 'medium' ? 'grid-cols-5' : 'grid-cols-6');
                const isGameDone = gameState.matched.length === (difficulty === 'medium' ? 24 : (difficulty === 'easy' ? 16 : 36));

                return (
                    <div className="min-h-screen bg-slate-900 p-4 flex flex-col items-center">
                        <div className="w-full max-w-4xl flex justify-between items-center mb-6 text-white pt-4">
                            <button onClick={() => setView('menu')} className="text-slate-400 hover:text-white flex items-center gap-1 py-2 px-4 bg-white/5 rounded-lg transition-colors">
                                <Icon name="x" size={20} /> çµæŸéŠæˆ²
                            </button>
                            <div className="text-center">
                                <span className="text-xs uppercase tracking-widest text-indigo-400 block mb-1">é…å°é€²åº¦</span>
                                <h2 className="text-2xl font-mono font-bold">{gameState.matched.length / 2} <span className="text-slate-500">/</span> {difficulty === 'easy' ? 8 : (difficulty === 'medium' ? 12 : 18)}</h2>
                            </div>
                            <div className="w-24"></div>
                        </div>

                        <div className={`grid ${gridCols} gap-2 md:gap-4 w-full max-w-2xl aspect-square`}>
                            {gameState.cards.map((card, idx) => {
                                if (card.isSpacer) return (
                                    <div key="spacer" className="bg-slate-800/50 rounded-xl flex flex-col items-center justify-center text-slate-600 border border-slate-700">
                                        <Icon name="shield" size={32} className="opacity-20 mb-1" />
                                        <span className="text-[10px] uppercase font-bold tracking-tighter opacity-20">Secure</span>
                                    </div>
                                );
                                const isFlipped = gameState.flipped.includes(idx) || gameState.matched.includes(idx);
                                return (
                                    <div key={card.instanceId} onClick={() => handleCardClick(idx)} className={`relative cursor-pointer transition-all duration-500 preserve-3d h-full ${isFlipped ? 'rotate-y-180' : ''}`}>
                                        <div className="absolute inset-0 backface-hidden bg-indigo-700 rounded-xl shadow-lg flex items-center justify-center border-2 border-indigo-500/50">
                                            <div className="w-10 h-10 rounded-full border-4 border-white/10 flex items-center justify-center">
                                                <span className="text-white text-2xl font-black opacity-30">?</span>
                                            </div>
                                        </div>
                                        <div className="absolute inset-0 backface-hidden rotate-y-180 bg-white rounded-xl shadow-lg overflow-hidden border-2 border-indigo-400">
                                            <img src={card.image} className="w-full h-full object-cover" onError={(e) => e.target.src='https://via.placeholder.com/200?text=Error'} />
                                            {gameState.matched.includes(idx) && (
                                                <div className="absolute inset-0 bg-emerald-500/20 flex items-center justify-center">
                                                    <div className="bg-emerald-500 text-white rounded-full p-1"><Icon name="check" size={16} /></div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {gameState.currentMatchInfo && (
                            <div className="fixed inset-0 bg-black/90 flex items-center justify-center p-6 z-50 backdrop-blur-sm">
                                <div className="bg-white rounded-[2rem] max-w-md w-full overflow-hidden shadow-2xl animate-in zoom-in duration-300">
                                    <div className="relative h-56 w-full">
                                        <img src={gameState.currentMatchInfo.image} className="h-full w-full object-cover" />
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                                        <div className="absolute bottom-4 left-6 text-white">
                                            <span className="bg-emerald-500 text-[10px] font-bold px-2 py-0.5 rounded-full uppercase tracking-widest mb-1 inline-block">Matched</span>
                                            <h3 className="text-2xl font-bold">{gameState.currentMatchInfo.name}</h3>
                                        </div>
                                    </div>
                                    <div className="p-8">
                                        <p className="text-slate-600 mb-8 leading-relaxed text-lg">{gameState.currentMatchInfo.info}</p>
                                        <button onClick={() => setGameState(prev => ({ ...prev, currentMatchInfo: null }))} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-indigo-700 transition-colors">
                                            è¨˜ä½äº†ï¼Œç¹¼çºŒéŠæˆ²
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isGameDone && !gameState.currentMatchInfo && (
                            <div className="mt-12 text-center">
                                <h3 className="text-white text-xl mb-4 font-bold">ğŸ‰ å¤ªæ£’äº†ï¼å·²æˆåŠŸé…å°æ‰€æœ‰è¨­å‚™</h3>
                                <button onClick={startQuiz} className="bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-600 hover:to-teal-600 text-white px-10 py-5 rounded-3xl font-bold text-2xl shadow-[0_0_30px_rgba(16,185,129,0.4)] flex items-center gap-3 transition-all hover:scale-105 active:scale-95">
                                    <Icon name="trophy" size={28} /> é€²å…¥æŒ‘æˆ°æ¸¬é©—
                                </button>
                            </div>
                        )}
                    </div>
                );
            };

            const QuizView = () => {
                const q = quizState.questions[quizState.currentIndex];
                const isLast = quizState.currentIndex === quizState.questions.length - 1;
                
                if (!q) return null;

                const handleAnswer = (idx) => {
                    const isCorrect = idx === q.correct;
                    const newScore = isCorrect ? quizState.score + 1 : quizState.score;
                    const newResults = [...quizState.results, { question: q.deviceName, isCorrect }];
                    if (isLast) { 
                        setQuizState(prev => ({ ...prev, score: newScore, results: newResults })); 
                        setView('result'); 
                    } else { 
                        setQuizState(prev => ({ ...prev, score: newScore, results: newResults, currentIndex: prev.currentIndex + 1 })); 
                    }
                };

                return (
                    <div className="min-h-screen bg-indigo-50 flex items-center justify-center p-6">
                        <div className="bg-white rounded-[2.5rem] shadow-2xl max-w-xl w-full p-10">
                            <div className="flex justify-between items-center mb-10">
                                <div className="flex gap-1">
                                    {quizState.questions.map((_, i) => (
                                        <div key={i} className={`h-1.5 w-6 rounded-full ${i === quizState.currentIndex ? 'bg-indigo-600' : (i < quizState.currentIndex ? 'bg-indigo-200' : 'bg-slate-100')}`}></div>
                                    ))}
                                </div>
                                <span className="text-sm font-bold text-slate-400 uppercase tracking-widest">Question {quizState.currentIndex + 1}</span>
                            </div>
                            <h2 className="text-3xl font-bold text-slate-800 mb-10 leading-tight">
                                {q.question.replace('{name}', q.deviceName)}
                            </h2>
                            <div className="space-y-4">
                                {q.options.map((opt, idx) => (
                                    <button 
                                        key={idx} 
                                        onClick={() => handleAnswer(idx)} 
                                        className="w-full text-left p-6 rounded-2xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 hover:shadow-md transition-all font-bold text-lg group flex items-center justify-between"
                                    >
                                        <span>{opt}</span>
                                        <Icon name="chevron-right" className="opacity-0 group-hover:opacity-100 text-indigo-500 transition-all -translate-x-2 group-hover:translate-x-0" />
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const ResultView = () => {
                const percentage = Math.round((quizState.score / quizState.questions.length) * 100);
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6">
                        <div className="bg-white rounded-[3rem] shadow-2xl max-w-md w-full p-12 text-center">
                            <div className={`w-24 h-24 rounded-3xl flex items-center justify-center mx-auto mb-8 rotate-12 ${percentage >= 60 ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600'}`}>
                                <Icon name={percentage >= 60 ? "award" : "frown"} size={54} />
                            </div>
                            <h2 className="text-3xl font-bold text-slate-800 mb-2">å­¸ç¿’è©•é‡çµæœ</h2>
                            <p className="text-slate-500 mb-10">æ­å–œå®Œæˆæœ¬æ¬¡è¨­å‚™å­¸ç¿’ï¼</p>
                            
                            <div className="relative inline-block mb-10">
                                <div className="text-8xl font-black text-indigo-600">{percentage}</div>
                                <div className="absolute -top-2 -right-6 text-2xl font-bold text-indigo-300">åˆ†</div>
                            </div>

                            <div className="grid grid-cols-2 gap-4 mb-10">
                                <div className="bg-slate-50 p-4 rounded-2xl">
                                    <span className="block text-xs font-bold text-slate-400 uppercase">æ­£ç¢ºç­”å°</span>
                                    <span className="text-2xl font-bold text-slate-700">{quizState.score} é¡Œ</span>
                                </div>
                                <div className="bg-slate-50 p-4 rounded-2xl">
                                    <span className="block text-xs font-bold text-slate-400 uppercase">ç¸½é¡Œç›®æ•¸</span>
                                    <span className="text-2xl font-bold text-slate-700">{quizState.questions.length} é¡Œ</span>
                                </div>
                            </div>

                            <button onClick={() => setView('menu')} className="w-full bg-indigo-600 text-white font-bold py-5 rounded-2xl shadow-xl hover:bg-indigo-700 transition-all hover:scale-[1.02] active:scale-[0.98]">
                                è¿”å›ä¸»é¸å–®
                            </button>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen">
                    {view === 'menu' && <MainMenu />}
                    {view === 'game' && <GameBoard />}
                    {view === 'quiz' && <QuizView />}
                    {view === 'result' && <ResultView />}
                    {view === 'admin_login' && <AdminLogin />}
                    {view === 'admin' && <AdminView />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
