<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備記憶翻牌學習遊戲</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>

    <style>
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .animate-spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* 自定義捲軸 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50">
    <div id="root"></div>

    <script type="babel" data-type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, updateDoc, query } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        const { useState, useEffect, useMemo } = React;

        // --- Firebase 配置 ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'memory-learning-game';

        // --- 小圖標組件 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('menu'); // menu, game, quiz, admin_login, admin, result
            const [cardsData, setCardsData] = useState([]);
            const [difficulty, setDifficulty] = useState(null);
            
            // 遊戲狀態
            const [gameState, setGameState] = useState({
                cards: [],
                flipped: [],
                matched: [],
                currentMatchInfo: null,
                matchedCardsData: [],
            });

            // 測驗狀態
            const [quizState, setQuizState] = useState({
                questions: [],
                currentIndex: 0,
                score: 0,
                results: []
            });

            // 1. 初始化與資料同步
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                const unsubscribeAuth = onAuthStateChanged(auth, setUser);
                return () => unsubscribeAuth();
            }, []);

            useEffect(() => {
                if (!user) return;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'deviceCards');
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCardsData(data);
                }, (err) => console.error("Firestore Error:", err));
                return () => unsubscribe();
            }, [user]);

            // 2. 遊戲邏輯
            const startGame = (diff) => {
                setDifficulty(diff);
                let pairsCount = diff === 'easy' ? 8 : (diff === 'medium' ? 12 : 18);

                if (cardsData.length < pairsCount) {
                    alert(`資料庫資料不足！目前僅有 ${cardsData.length} 種設備，請先至後台新增（至少需 ${pairsCount} 種）。`);
                    return;
                }

                const selectedData = [...cardsData].sort(() => 0.5 - Math.random()).slice(0, pairsCount);
                let cards = [];
                selectedData.forEach((item, index) => {
                    const baseCard = { deviceId: item.id, name: item.name, image: item.image, info: item.info };
                    cards.push({ ...baseCard, instanceId: `${index}-a` });
                    cards.push({ ...baseCard, instanceId: `${index}-b` });
                });

                cards = cards.sort(() => 0.5 - Math.random());

                if (diff === 'medium') {
                    cards.splice(12, 0, { isSpacer: true });
                }

                setGameState({
                    cards,
                    flipped: [],
                    matched: [],
                    currentMatchInfo: null,
                    matchedCardsData: selectedData
                });
                setView('game');
            };

            const handleCardClick = (index) => {
                const { flipped, matched, cards } = gameState;
                if (flipped.length === 2 || matched.includes(index) || flipped.includes(index) || cards[index].isSpacer) return;

                const newFlipped = [...flipped, index];
                setGameState(prev => ({ ...prev, flipped: newFlipped }));

                if (newFlipped.length === 2) {
                    const card1 = cards[newFlipped[0]];
                    const card2 = cards[newFlipped[1]];

                    if (card1.deviceId === card2.deviceId) {
                        setTimeout(() => {
                            const newMatched = [...matched, newFlipped[0], newFlipped[1]];
                            setGameState(prev => ({
                                ...prev,
                                matched: newMatched,
                                flipped: [],
                                currentMatchInfo: card1
                            }));
                        }, 500);
                    } else {
                        setTimeout(() => {
                            setGameState(prev => ({ ...prev, flipped: [] }));
                        }, 1000);
                    }
                }
            };

            const startQuiz = () => {
                const questions = gameState.matchedCardsData.map(item => ({
                    deviceId: item.id,
                    deviceName: item.name,
                    question: item.question,
                    options: item.options,
                    correct: item.correct
                })).sort(() => 0.5 - Math.random());

                setQuizState({ questions, currentIndex: 0, score: 0, results: [] });
                setView('quiz');
            };

            // --- 組件視圖 ---

            const MainMenu = () => (
                <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-6">
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                        <div className="mb-6 inline-flex p-4 bg-indigo-100 rounded-2xl text-indigo-600">
                            <Icon name="book-open" size={48} />
                        </div>
                        <h1 className="text-3xl font-bold text-slate-800 mb-2">設備記憶大挑戰</h1>
                        <p className="text-slate-500 mb-8">翻開卡牌配對設備，並學習相關專業知識！</p>
                        
                        <div className="space-y-4">
                            <button onClick={() => startGame('easy')} className="w-full flex items-center justify-between p-4 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-xl transition-colors">
                                <div className="text-left">
                                    <span className="block font-bold text-emerald-700 text-lg">簡單模式</span>
                                    <span className="text-sm text-emerald-600">4x4 共 8 組配對</span>
                                </div>
                                <Icon name="chevron-right" className="text-emerald-400" />
                            </button>
                            <button onClick={() => startGame('medium')} className="w-full flex items-center justify-between p-4 bg-amber-50 hover:bg-amber-100 border border-amber-200 rounded-xl transition-colors">
                                <div className="text-left">
                                    <span className="block font-bold text-amber-700 text-lg">中等模式</span>
                                    <span className="text-sm text-amber-600">5x5 中間空格，12 組配對</span>
                                </div>
                                <Icon name="chevron-right" className="text-amber-400" />
                            </button>
                            <button onClick={() => startGame('hard')} className="w-full flex items-center justify-between p-4 bg-rose-50 hover:bg-rose-100 border border-rose-200 rounded-xl transition-colors">
                                <div className="text-left">
                                    <span className="block font-bold text-rose-700 text-lg">困難模式</span>
                                    <span className="text-sm text-rose-600">6x6 共 18 組配對</span>
                                </div>
                                <Icon name="chevron-right" className="text-rose-400" />
                            </button>
                        </div>

                        <button onClick={() => setView('admin_login')} className="mt-8 text-slate-400 hover:text-indigo-600 flex items-center gap-2 text-sm mx-auto">
                            <Icon name="settings" size={16} /> 管理後台
                        </button>
                    </div>
                </div>
            );

            const AdminLogin = () => {
                const [creds, setCreds] = useState({ user: '', pass: '' });
                const handleLogin = (e) => {
                    e.preventDefault();
                    if (creds.user === 'Admin01' && creds.pass === '76380260') {
                        setView('admin');
                    } else {
                        alert('帳號或密碼錯誤！');
                    }
                };
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-slate-100">
                        <form onSubmit={handleLogin} className="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full">
                            <h2 className="text-2xl font-bold mb-6 text-center">管理員登入</h2>
                            <div className="space-y-4">
                                <input type="text" placeholder="帳號" className="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 ring-indigo-500" value={creds.user} onChange={e => setCreds({...creds, user: e.target.value})} />
                                <input type="password" placeholder="密碼" className="w-full p-3 bg-slate-50 border rounded-xl outline-none focus:ring-2 ring-indigo-500" value={creds.pass} onChange={e => setCreds({...creds, pass: e.target.value})} />
                                <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold">登入</button>
                                <button type="button" onClick={() => setView('menu')} className="w-full text-slate-400 py-2">返回首頁</button>
                            </div>
                        </form>
                    </div>
                );
            };

            const AdminView = () => {
                const [newItem, setNewItem] = useState({
                    name: '', image: '', info: '', question: '請問下列哪一項是關於 {name} 的正確描述？', options: ['', '', '', ''], correct: 0
                });
                const [editingId, setEditingId] = useState(null);
                const [loading, setLoading] = useState(false);

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!newItem.name || !newItem.image || !newItem.info) return alert('請填寫完整資訊');
                    setLoading(true);
                    try {
                        if (editingId) {
                            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'deviceCards', editingId), newItem);
                            alert('更新成功！');
                        } else {
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'deviceCards'), newItem);
                            alert('新增成功！');
                        }
                        resetForm();
                    } catch (err) { console.error(err); }
                    setLoading(false);
                };

                const resetForm = () => {
                    setNewItem({ name: '', image: '', info: '', question: '請問下列哪一項是關於 {name} 的正確描述？', options: ['', '', '', ''], correct: 0 });
                    setEditingId(null);
                };

                const startEdit = (item) => {
                    setNewItem({ ...item });
                    setEditingId(item.id);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                };

                const deleteItem = async (id) => {
                    if (!confirm('確定要刪除此設備資料嗎？')) return;
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'deviceCards', id));
                };

                return (
                    <div className="min-h-screen bg-slate-50 p-6">
                        <div className="max-w-4xl mx-auto">
                            <div className="flex justify-between items-center mb-8">
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-2"><Icon name="settings" /> 後台管理</h1>
                                <button onClick={() => setView('menu')} className="bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-lg font-bold">離開後台</button>
                            </div>

                            <div className="grid md:grid-cols-2 gap-8">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100">
                                    <h2 className="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-600">
                                        <Icon name={editingId ? "edit" : "plus"} size={18} /> 
                                        {editingId ? "編輯設備資料" : "新增設備"}
                                    </h2>
                                    <form onSubmit={handleSubmit} className="space-y-4">
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1">設備名稱</label>
                                            <input value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} className="w-full p-3 rounded-xl bg-slate-50 border outline-none focus:border-indigo-500" placeholder="例如：超音波診斷儀" />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1">圖片網址</label>
                                            <input value={newItem.image} onChange={e => setNewItem({...newItem, image: e.target.value})} className="w-full p-3 rounded-xl bg-slate-50 border outline-none focus:border-indigo-500" placeholder="https://..." />
                                        </div>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-400 uppercase mb-1">詳細介紹</label>
                                            <textarea value={newItem.info} onChange={e => setNewItem({...newItem, info: e.target.value})} className="w-full p-3 rounded-xl bg-slate-50 border outline-none h-24" placeholder="設備功能描述..." />
                                        </div>
                                        <hr />
                                        <h3 className="font-bold text-slate-700 text-sm">測驗題目設定</h3>
                                        <input value={newItem.question} onChange={e => setNewItem({...newItem, question: e.target.value})} className="w-full p-3 rounded-xl bg-slate-50 border outline-none" />
                                        <div className="space-y-2">
                                            {newItem.options.map((opt, idx) => (
                                                <div key={idx} className="flex gap-2 items-center">
                                                    <input type="radio" checked={newItem.correct === idx} onChange={() => setNewItem({...newItem, correct: idx})} />
                                                    <input value={opt} onChange={e => {
                                                        const newOpts = [...newItem.options];
                                                        newOpts[idx] = e.target.value;
                                                        setNewItem({...newItem, options: newOpts});
                                                    }} className="flex-1 p-2 bg-slate-50 border rounded-lg text-sm" placeholder={`選項 ${idx + 1}`} />
                                                </div>
                                            ))}
                                        </div>
                                        <div className="flex gap-2">
                                            <button disabled={loading} type="submit" className="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-md">
                                                {editingId ? '確認更新' : '確認新增'}
                                            </button>
                                            {editingId && <button type="button" onClick={resetForm} className="px-4 py-3 bg-slate-200 rounded-xl font-bold">取消編輯</button>}
                                        </div>
                                    </form>
                                </div>

                                <div className="space-y-4">
                                    <h2 className="text-lg font-bold">目前庫存資料 ({cardsData.length})</h2>
                                    <div className="max-h-[600px] overflow-y-auto space-y-3">
                                        {cardsData.map(item => (
                                            <div key={item.id} className="bg-white p-4 rounded-xl flex items-center gap-4 border border-slate-100 shadow-sm">
                                                <img src={item.image} className="w-16 h-16 rounded-lg object-cover bg-slate-100" />
                                                <div className="flex-1">
                                                    <h4 className="font-bold text-slate-800">{item.name}</h4>
                                                    <div className="flex gap-3 mt-2">
                                                        <button onClick={() => startEdit(item)} className="text-xs text-indigo-600 font-bold hover:underline flex items-center gap-1">
                                                            <Icon name="edit" size={12} /> 編輯
                                                        </button>
                                                        <button onClick={() => deleteItem(item.id)} className="text-xs text-rose-500 font-bold hover:underline flex items-center gap-1">
                                                            <Icon name="trash-2" size={12} /> 刪除
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const GameBoard = () => {
                const gridCols = difficulty === 'easy' ? 'grid-cols-4' : (difficulty === 'medium' ? 'grid-cols-5' : 'grid-cols-6');
                const isGameDone = gameState.matched.length === (difficulty === 'medium' ? 24 : (difficulty === 'easy' ? 16 : 36));

                return (
                    <div className="min-h-screen bg-slate-900 p-4 flex flex-col items-center">
                        <div className="w-full max-w-4xl flex justify-between items-center mb-6 text-white">
                            <button onClick={() => setView('menu')} className="text-slate-400 hover:text-white flex items-center gap-1">
                                <Icon name="x" size={20} /> 結束
                            </button>
                            <h2 className="text-xl font-bold">進度: {gameState.matched.length / 2} / {difficulty === 'easy' ? 8 : (difficulty === 'medium' ? 12 : 18)}</h2>
                            <div className="w-10"></div>
                        </div>

                        <div className={`grid ${gridCols} gap-2 md:gap-4 w-full max-w-2xl aspect-square`}>
                            {gameState.cards.map((card, idx) => {
                                if (card.isSpacer) return <div key="spacer" className="bg-slate-800 rounded-lg flex items-center justify-center text-slate-600"><Icon name="settings" className="animate-spin-slow" /></div>;
                                const isFlipped = gameState.flipped.includes(idx) || gameState.matched.includes(idx);
                                return (
                                    <div key={card.instanceId} onClick={() => handleCardClick(idx)} className={`relative cursor-pointer transition-all duration-500 preserve-3d h-full ${isFlipped ? 'rotate-y-180' : ''}`}>
                                        <div className="absolute inset-0 backface-hidden bg-indigo-700 rounded-lg shadow-lg flex items-center justify-center border-2 border-indigo-500">
                                            <span className="text-white text-xl font-bold opacity-30">?</span>
                                        </div>
                                        <div className="absolute inset-0 backface-hidden rotate-y-180 bg-white rounded-lg shadow-lg overflow-hidden border-2 border-indigo-400">
                                            <img src={card.image} className="w-full h-full object-cover" />
                                        </div>
                                    </div>
                                );
                            })}
                        </div>

                        {gameState.currentMatchInfo && (
                            <div className="fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50">
                                <div className="bg-white rounded-3xl max-w-md w-full overflow-hidden shadow-2xl">
                                    <img src={gameState.currentMatchInfo.image} className="h-48 w-full object-cover" />
                                    <div className="p-8">
                                        <h3 className="text-2xl font-bold text-slate-800 mb-2">{gameState.currentMatchInfo.name}</h3>
                                        <p className="text-slate-600 mb-6 leading-relaxed">{gameState.currentMatchInfo.info}</p>
                                        <button onClick={() => setGameState(prev => ({ ...prev, currentMatchInfo: null }))} className="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl">繼續挑戰</button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {isGameDone && !gameState.currentMatchInfo && (
                            <div className="mt-8">
                                <button onClick={startQuiz} className="bg-emerald-500 hover:bg-emerald-600 text-white px-8 py-4 rounded-2xl font-bold text-xl shadow-lg flex items-center gap-3 animate-bounce">
                                    <Icon name="trophy" /> 進入知識測驗
                                </button>
                            </div>
                        )}
                    </div>
                );
            };

            const QuizView = () => {
                const q = quizState.questions[quizState.currentIndex];
                const isLast = quizState.currentIndex === quizState.questions.length - 1;
                const handleAnswer = (idx) => {
                    const isCorrect = idx === q.correct;
                    const newScore = isCorrect ? quizState.score + 1 : quizState.score;
                    const newResults = [...quizState.results, { question: q.deviceName, isCorrect }];
                    if (isLast) { setQuizState(prev => ({ ...prev, score: newScore, results: newResults })); setView('result'); }
                    else { setQuizState(prev => ({ ...prev, score: newScore, results: newResults, currentIndex: prev.currentIndex + 1 })); }
                };
                return (
                    <div className="min-h-screen bg-indigo-50 flex items-center justify-center p-6">
                        <div className="bg-white rounded-3xl shadow-xl max-w-xl w-full p-8">
                            <div className="flex justify-between items-center mb-6 text-sm font-bold text-indigo-500">
                                <span>問題 {quizState.currentIndex + 1} / {quizState.questions.length}</span>
                                <span>正確率: {quizState.score}</span>
                            </div>
                            <h2 className="text-2xl font-bold text-slate-800 mb-8">{q.question.replace('{name}', q.deviceName)}</h2>
                            <div className="space-y-4">
                                {q.options.map((opt, idx) => (
                                    <button key={idx} onClick={() => handleAnswer(idx)} className="w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 transition-all font-medium">{opt}</button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const ResultView = () => (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6">
                    <div className="bg-white rounded-3xl shadow-xl max-w-md w-full p-8 text-center">
                        <div className="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6 text-emerald-600"><Icon name="trophy" size={40} /></div>
                        <h2 className="text-3xl font-bold mb-2">測驗完成！</h2>
                        <div className="text-6xl font-black text-indigo-600 mb-8">{Math.round((quizState.score / quizState.questions.length) * 100)}<span className="text-2xl">分</span></div>
                        <button onClick={() => setView('menu')} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg mb-4">返回主選單</button>
                    </div>
                </div>
            );

            return (
                <div>
                    {view === 'menu' && <MainMenu />}
                    {view === 'game' && <GameBoard />}
                    {view === 'quiz' && <QuizView />}
                    {view === 'result' && <ResultView />}
                    {view === 'admin_login' && <AdminLogin />}
                    {view === 'admin' && <AdminView />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
