<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>設備記憶翻牌學習遊戲</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .animate-spin-slow { animation: spin 8s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* 自定義捲軸 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // ==========================================
        // Firebase 設定區 (已更新為您的專屬資訊)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAmCOliFc1-qMDVgCGzD33gDCKF8KT1fIo",
            authDomain: "turn-cards-game.firebaseapp.com",
            projectId: "turn-cards-game",
            storageBucket: "turn-cards-game.firebasestorage.app",
            messagingSenderId: "952397521252",
            appId: "1:952397521252:web:51e7af9203ce6d9a235a71"
        };
        // ==========================================

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const appId = 'turn-cards-game'; 

        // 預設佔位圖，當使用者輸入無效網址時顯示
        const PLACEHOLDER_IMG = "https://via.placeholder.com/400x300?text=Image+Not+Found";

        // --- 圖標組件 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} style={{ width: size, height: size }} className={`inline-block ${className}`}></i>;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('menu'); 
            const [cardsData, setCardsData] = useState([]);
            const [difficulty, setDifficulty] = useState(null);
            
            const [gameState, setGameState] = useState({
                cards: [],
                flipped: [],
                matched: [],
                currentMatchInfo: null,
                matchedCardsData: [],
            });

            const [quizState, setQuizState] = useState({
                questions: [],
                currentIndex: 0,
                score: 0,
                results: []
            });

            // 1. 初始化登入
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await auth.signInAnonymously();
                    } catch (err) {
                        console.error("Auth Error:", err.message);
                    }
                };
                initAuth();
                const unsubscribeAuth = auth.onAuthStateChanged(setUser);
                return () => unsubscribeAuth();
            }, []);

            // 2. 即時同步資料庫
            useEffect(() => {
                if (!user) return;
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('deviceCards');
                
                const unsubscribe = collectionRef.onSnapshot((snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setCardsData(data);
                }, (err) => {
                    console.error("Firestore Error:", err.message);
                });
                return () => unsubscribe();
            }, [user]);

            // --- 遊戲邏輯 ---
            const startGame = (diff) => {
                setDifficulty(diff);
                let pairsCount = diff === 'easy' ? 8 : (diff === 'medium' ? 12 : 18);
                if (cardsData.length < pairsCount) {
                    alert(`資料庫資料不足！目前僅有 ${cardsData.length} 種設備，請先由管理後台新增（至少需 ${pairsCount} 種）。`);
                    return;
                }
                const selectedData = [...cardsData].sort(() => 0.5 - Math.random()).slice(0, pairsCount);
                let cards = [];
                selectedData.forEach((item, index) => {
                    const baseCard = { deviceId: item.id, name: item.name, image: item.image, info: item.info };
                    cards.push({ ...baseCard, instanceId: `${index}-a` });
                    cards.push({ ...baseCard, instanceId: `${index}-b` });
                });
                cards = cards.sort(() => 0.5 - Math.random());
                if (diff === 'medium') cards.splice(12, 0, { isSpacer: true });
                setGameState({ cards, flipped: [], matched: [], currentMatchInfo: null, matchedCardsData: selectedData });
                setView('game');
            };

            const handleCardClick = (index) => {
                const { flipped, matched, cards } = gameState;
                if (flipped.length === 2 || matched.includes(index) || flipped.includes(index) || cards[index].isSpacer) return;
                const newFlipped = [...flipped, index];
                setGameState(prev => ({ ...prev, flipped: newFlipped }));
                if (newFlipped.length === 2) {
                    const card1 = cards[newFlipped[0]];
                    const card2 = cards[newFlipped[1]];
                    if (card1.deviceId === card2.deviceId) {
                        setTimeout(() => {
                            const newMatched = [...matched, newFlipped[0], newFlipped[1]];
                            setGameState(prev => ({ ...prev, matched: newMatched, flipped: [], currentMatchInfo: card1 }));
                        }, 500);
                    } else {
                        setTimeout(() => setGameState(prev => ({ ...prev, flipped: [] })), 1000);
                    }
                }
            };

            const startQuiz = () => {
                const questions = gameState.matchedCardsData.map(item => ({
                    deviceId: item.id, deviceName: item.name, question: item.question, options: item.options, correct: item.correct
                })).sort(() => 0.5 - Math.random());
                setQuizState({ questions, currentIndex: 0, score: 0, results: [] });
                setView('quiz');
            };

            // --- 視圖組件 ---

            const MainMenu = () => (
                <div className="flex flex-col items-center justify-center min-h-screen p-6">
                    <div className="bg-white p-8 rounded-3xl shadow-xl max-w-md w-full text-center">
                        <div className="mb-6 inline-flex p-4 bg-indigo-100 rounded-2xl text-indigo-600">
                            <Icon name="book-open" size={48} />
                        </div>
                        <h1 className="text-3xl font-bold text-slate-800 mb-2">設備記憶翻牌</h1>
                        <p className="text-slate-500 mb-8">配對設備並學習專業知識</p>
                        <div className="space-y-4 text-left">
                            <button onClick={() => startGame('easy')} className="w-full flex items-center justify-between p-4 bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 rounded-xl transition-all">
                                <div><span className="block font-bold text-emerald-700 text-lg">簡單模式 (4x4)</span></div>
                                <Icon name="play" className="text-emerald-400" />
                            </button>
                            <button onClick={() => startGame('medium')} className="w-full flex items-center justify-between p-4 bg-amber-50 hover:bg-amber-100 border border-amber-200 rounded-xl transition-all">
                                <div><span className="block font-bold text-amber-700 text-lg">中等模式 (5x5)</span></div>
                                <Icon name="play" className="text-amber-400" />
                            </button>
                            <button onClick={() => startGame('hard')} className="w-full flex items-center justify-between p-4 bg-rose-50 hover:bg-rose-100 border border-rose-200 rounded-xl transition-all">
                                <div><span className="block font-bold text-rose-700 text-lg">困難模式 (6x6)</span></div>
                                <Icon name="play" className="text-rose-400" />
                            </button>
                        </div>
                        <button onClick={() => setView('admin_login')} className="mt-10 text-slate-400 hover:text-indigo-600 flex items-center gap-2 text-sm mx-auto">
                            <Icon name="settings" size={16} /> 管理後台
                        </button>
                    </div>
                </div>
            );

            const AdminLogin = () => {
                const [creds, setCreds] = useState({ user: '', pass: '' });
                const handleLogin = (e) => {
                    e.preventDefault();
                    if (creds.user === 'Admin01' && creds.pass === '76380260') setView('admin');
                    else alert('帳號或密碼錯誤！');
                };
                return (
                    <div className="min-h-screen flex items-center justify-center p-6 bg-slate-100">
                        <form onSubmit={handleLogin} className="bg-white p-8 rounded-3xl shadow-2xl max-w-sm w-full text-center">
                            <Icon name="lock" size={40} className="text-indigo-600 mb-4" />
                            <h2 className="text-2xl font-bold mb-6">管理員登入</h2>
                            <div className="space-y-4">
                                <input type="text" placeholder="管理員帳號" className="w-full p-4 bg-slate-50 border rounded-xl outline-none focus:ring-2 ring-indigo-500" value={creds.user} onChange={e => setCreds({...creds, user: e.target.value})} />
                                <input type="password" placeholder="管理員密碼" className="w-full p-4 bg-slate-50 border rounded-xl outline-none focus:ring-2 ring-indigo-500" value={creds.pass} onChange={e => setCreds({...creds, pass: e.target.value})} />
                                <button type="submit" className="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg">登入系統</button>
                                <button type="button" onClick={() => setView('menu')} className="w-full text-slate-400 py-2">返回遊戲</button>
                            </div>
                        </form>
                    </div>
                );
            };

            const AdminView = () => {
                const [newItem, setNewItem] = useState({
                    name: '', image: '', info: '', question: '請問下列哪一項是關於 {name} 的正確描述？', options: ['', '', '', ''], correct: 0
                });
                const [editingId, setEditingId] = useState(null);
                const [loading, setLoading] = useState(false);
                const collectionRef = db.collection('artifacts').doc(appId).collection('public').doc('data').collection('deviceCards');

                const handleSubmit = async (e) => {
                    e.preventDefault();
                    if (!newItem.name || !newItem.image || !newItem.info) return alert('請填寫完整資訊');
                    setLoading(true);
                    try {
                        if (editingId) await collectionRef.doc(editingId).update(newItem);
                        else await collectionRef.add(newItem);
                        
                        setNewItem({ name: '', image: '', info: '', question: '請問下列哪一項是關於 {name} 的正確描述？', options: ['', '', '', ''], correct: 0 });
                        setEditingId(null);
                        alert('操作成功！');
                    } catch (err) { 
                        console.error("寫入錯誤:", err.message);
                        alert("存取遭拒。請確認您已在 Firebase 控制台設定正確的安全性規則。");
                    }
                    setLoading(false);
                };

                return (
                    <div className="min-h-screen bg-slate-50 p-6">
                        <div className="max-w-6xl mx-auto">
                            <div className="flex justify-between items-center mb-8 bg-white p-6 rounded-2xl shadow-sm border">
                                <h1 className="text-2xl font-bold text-slate-800 flex items-center gap-3"><Icon name="settings" className="text-indigo-600" /> 設備資料管理中心</h1>
                                <button onClick={() => setView('menu')} className="bg-slate-200 px-6 py-2 rounded-xl font-bold">離開後台</button>
                            </div>
                            <div className="grid lg:grid-cols-2 gap-8">
                                <div className="bg-white p-8 rounded-3xl shadow-sm border border-indigo-100">
                                    <h2 className="text-xl font-bold mb-6 text-indigo-600">{editingId ? '編輯設備資料' : '新增學習設備'}</h2>
                                    <form onSubmit={handleSubmit} className="space-y-4">
                                        <input value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border outline-none focus:ring-2 ring-indigo-500" placeholder="設備名稱 (例如: MRI 儀器)" />
                                        <div className="space-y-2">
                                            <input value={newItem.image} onChange={e => setNewItem({...newItem, image: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border outline-none focus:ring-2 ring-indigo-500" placeholder="圖片網址 (URL)" />
                                            {newItem.image && (
                                                <div className="mt-2 p-2 bg-slate-100 rounded-xl border border-dashed border-slate-300">
                                                    <p className="text-xs text-slate-400 mb-1 font-bold uppercase">圖片即時預覽：</p>
                                                    <img 
                                                        src={newItem.image} 
                                                        className="max-h-32 rounded-lg mx-auto" 
                                                        onError={(e) => { e.target.src = PLACEHOLDER_IMG; }} 
                                                        alt="預覽圖"
                                                    />
                                                    <p className="text-[10px] text-rose-500 mt-1">※ 若預覽顯示為 Placeholder，表示網址可能無效或非直連連結。</p>
                                                </div>
                                            )}
                                        </div>
                                        <textarea value={newItem.info} onChange={e => setNewItem({...newItem, info: e.target.value})} className="w-full p-4 rounded-xl bg-slate-50 border outline-none h-32 focus:ring-2 ring-indigo-500" placeholder="設備詳細介紹與用途..." />
                                        <div className="p-4 bg-indigo-50 rounded-2xl">
                                            <p className="font-bold text-sm mb-2 text-indigo-700">測驗題目與選項</p>
                                            <input value={newItem.question} onChange={e => setNewItem({...newItem, question: e.target.value})} className="w-full p-2 mb-3 rounded border border-indigo-200 outline-none" placeholder="問題模板" />
                                            {newItem.options.map((opt, i) => (
                                                <div key={i} className="flex gap-2 mb-2">
                                                    <input type="radio" name="quiz-ans" checked={newItem.correct === i} onChange={() => setNewItem({...newItem, correct: i})} />
                                                    <input value={opt} onChange={e => {
                                                        const newOpts = [...newItem.options]; newOpts[i] = e.target.value;
                                                        setNewItem({...newItem, options: newOpts});
                                                    }} className="flex-1 p-2 rounded border border-white text-sm focus:border-indigo-300 outline-none" placeholder={`答案選項 ${i+1}`} />
                                                </div>
                                            ))}
                                        </div>
                                        <button disabled={loading} type="submit" className="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl hover:bg-indigo-700 transition-colors">
                                            {loading ? '處理中...' : (editingId ? '儲存修改內容' : '確認新增資料')}
                                        </button>
                                        {editingId && <button onClick={() => {setEditingId(null); setNewItem({name:'',image:'',info:'',question:'請問下列哪一項是關於 {name} 的正確描述？',options:['','','',''],correct:0})}} type="button" className="w-full bg-slate-200 py-3 rounded-xl mt-2 font-medium">取消編輯</button>}
                                    </form>
                                </div>
                                <div className="space-y-4">
                                    <h2 className="text-xl font-bold text-slate-800 flex justify-between">
                                        <span>現有設備庫</span>
                                        <span className="text-sm bg-slate-200 px-3 py-1 rounded-full">{cardsData.length}</span>
                                    </h2>
                                    <div className="max-h-[700px] overflow-y-auto space-y-4 pr-2">
                                        {cardsData.map(item => (
                                            <div key={item.id} className="bg-white p-4 rounded-2xl flex items-center gap-4 border shadow-sm group hover:border-indigo-300 transition-all">
                                                <img 
                                                    src={item.image} 
                                                    className="w-20 h-20 rounded-xl object-cover bg-slate-100 flex-shrink-0" 
                                                    onError={(e) => { e.target.src = PLACEHOLDER_IMG; }}
                                                />
                                                <div className="flex-1 min-w-0">
                                                    <h4 className="font-bold text-slate-800 truncate">{item.name}</h4>
                                                    <div className="flex gap-4 mt-2">
                                                        <button onClick={() => {setEditingId(item.id); setNewItem({...item});}} className="text-sm text-indigo-600 font-bold hover:underline">編輯</button>
                                                        <button onClick={() => { if(confirm('確定刪除？')) collectionRef.doc(item.id).delete(); }} className="text-sm text-rose-500 font-bold hover:underline">刪除</button>
                                                    </div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const GameBoard = () => {
                const gridCols = difficulty === 'easy' ? 'grid-cols-4' : (difficulty === 'medium' ? 'grid-cols-5' : 'grid-cols-6');
                const isGameDone = gameState.matched.length === (difficulty === 'medium' ? 24 : (difficulty === 'easy' ? 16 : 36));
                return (
                    <div className="min-h-screen bg-slate-900 p-4 flex flex-col items-center justify-center">
                        <div className="w-full max-w-2xl flex justify-between items-center mb-6 text-white font-mono">
                            <button onClick={() => setView('menu')} className="text-slate-400 hover:text-white">結束離開</button>
                            <h2 className="text-2xl font-bold">{gameState.matched.length / 2} <span className="text-slate-600">/</span> {difficulty === 'easy' ? 8 : (difficulty === 'medium' ? 12 : 18)}</h2>
                            <div className="w-10"></div>
                        </div>
                        <div className={`grid ${gridCols} gap-2 md:gap-4 w-full max-w-2xl aspect-square`}>
                            {gameState.cards.map((card, idx) => {
                                if (card.isSpacer) return <div key="spacer" className="bg-slate-800 rounded-xl flex items-center justify-center text-slate-700"><Icon name="shield" size={32} className="opacity-20 animate-pulse" /></div>;
                                const isFlipped = gameState.flipped.includes(idx) || gameState.matched.includes(idx);
                                return (
                                    <div key={card.instanceId} onClick={() => handleCardClick(idx)} className={`relative cursor-pointer transition-all duration-500 preserve-3d h-full ${isFlipped ? 'rotate-y-180' : ''}`}>
                                        <div className="absolute inset-0 backface-hidden bg-indigo-700 rounded-xl flex items-center justify-center border-2 border-indigo-500"><span className="text-white text-3xl font-black opacity-10">?</span></div>
                                        <div className="absolute inset-0 backface-hidden rotate-y-180 bg-slate-200 rounded-xl overflow-hidden border-2 border-indigo-400">
                                            <img 
                                                src={card.image} 
                                                className="w-full h-full object-cover" 
                                                onError={(e) => { e.target.src = PLACEHOLDER_IMG; }}
                                            />
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        {gameState.currentMatchInfo && (
                            <div className="fixed inset-0 bg-black/95 flex items-center justify-center p-6 z-50 backdrop-blur-sm">
                                <div className="bg-white rounded-[2rem] max-w-md w-full overflow-hidden shadow-2xl text-center animate-in zoom-in duration-300">
                                    <img 
                                        src={gameState.currentMatchInfo.image} 
                                        className="h-52 w-full object-cover" 
                                        onError={(e) => { e.target.src = PLACEHOLDER_IMG; }}
                                    />
                                    <div className="p-8">
                                        <span className="text-emerald-500 text-xs font-bold uppercase tracking-widest block mb-2">配對成功！</span>
                                        <h3 className="text-2xl font-bold mb-3">{gameState.currentMatchInfo.name}</h3>
                                        <p className="text-slate-600 mb-8 leading-relaxed">{gameState.currentMatchInfo.info}</p>
                                        <button onClick={() => setGameState(prev => ({ ...prev, currentMatchInfo: null }))} className="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-xl">記住了，繼續配對</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        {isGameDone && !gameState.currentMatchInfo && (
                            <div className="mt-8 text-center animate-bounce">
                                <button onClick={startQuiz} className="bg-gradient-to-r from-emerald-500 to-teal-500 text-white px-12 py-5 rounded-[2rem] font-bold text-2xl shadow-2xl flex items-center gap-3">
                                    <Icon name="award" /> 開始知識測驗
                                </button>
                            </div>
                        )}
                    </div>
                );
            };

            const QuizView = () => {
                const q = quizState.questions[quizState.currentIndex];
                const handleAnswer = (idx) => {
                    const isCorrect = idx === q.correct;
                    const newScore = isCorrect ? quizState.score + 1 : quizState.score;
                    const newResults = [...quizState.results, { question: q.deviceName, isCorrect }];
                    if (quizState.currentIndex === quizState.questions.length - 1) { 
                        setQuizState(prev => ({ ...prev, score: newScore, results: newResults })); 
                        setView('result'); 
                    } else {
                        setQuizState(prev => ({ ...prev, score: newScore, results: newResults, currentIndex: prev.currentIndex + 1 }));
                    }
                };
                if(!q) return null;
                return (
                    <div className="min-h-screen bg-indigo-50 flex items-center justify-center p-6">
                        <div className="bg-white rounded-[2.5rem] shadow-2xl max-w-xl w-full p-10">
                            <div className="flex justify-between items-center mb-10">
                                <span className="bg-indigo-100 text-indigo-700 px-4 py-1 rounded-full text-sm font-bold">第 {quizState.currentIndex+1} 題</span>
                                <span className="text-slate-400 font-bold">總計 {quizState.questions.length} 題</span>
                            </div>
                            <h2 className="text-3xl font-bold mb-10 text-slate-800">{q.question.replace('{name}', q.deviceName)}</h2>
                            <div className="space-y-4">
                                {q.options.map((opt, i) => (
                                    <button key={i} onClick={() => handleAnswer(i)} className="w-full text-left p-6 rounded-2xl border-2 border-slate-100 hover:border-indigo-500 hover:bg-indigo-50 font-bold transition-all text-lg shadow-sm hover:shadow-md">
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            };

            const ResultView = () => (
                <div className="min-h-screen bg-slate-50 flex flex-col items-center justify-center p-6 text-center">
                    <div className="bg-white rounded-[3rem] shadow-2xl max-w-md w-full p-12">
                        <div className="bg-indigo-100 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-8 text-indigo-600">
                            <Icon name="trophy" size={54} />
                        </div>
                        <h2 className="text-3xl font-bold mb-2 text-slate-800">測驗成績揭曉</h2>
                        <p className="text-slate-500 mb-10">已完成設備學習測驗！</p>
                        <div className="text-8xl font-black text-indigo-600 my-8">
                            {Math.round((quizState.score / quizState.questions.length) * 100)}<span className="text-2xl ml-1">分</span>
                        </div>
                        <div className="bg-slate-50 p-6 rounded-2xl mb-10 flex justify-between font-bold">
                            <span className="text-slate-400">答對題數</span>
                            <span className="text-slate-800">{quizState.score} / {quizState.questions.length}</span>
                        </div>
                        <button onClick={() => setView('menu')} className="w-full bg-indigo-600 text-white font-bold py-5 rounded-2xl shadow-xl hover:bg-indigo-700 transition-all">
                            返回主選單
                        </button>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen antialiased">
                    {view === 'menu' && <MainMenu />}
                    {view === 'game' && <GameBoard />}
                    {view === 'quiz' && <QuizView />}
                    {view === 'result' && <ResultView />}
                    {view === 'admin_login' && <AdminLogin />}
                    {view === 'admin' && <AdminView />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
